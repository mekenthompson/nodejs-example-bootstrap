steps:
  # 1. Interactive form – capture your org settings
  - block: ":gear: Configure your Buildkite org"
    prompt: |
      Fill in these details, then click **Unblock** to set up hosted agents,
      a Test Engine queue, and a Package Registry.
    fields:
      - text: "Org slug"
        key: org_slug
        required: true
        default: "bootstrap-example"
      - text: "Registry name"
        key: registry
        default: "bootstrap-registry"
      - select: "Hosted agent instance shape"
        key: shape
        options:
          - label: "2 vCPU / 4 GB Linux (LINUX_AMD64_2X4)"
            value: "LINUX_AMD64_2X4"
          - label: "4 vCPU / 8 GB Linux (LINUX_AMD64_4X8)"
            value: "LINUX_AMD64_4X8"
          - label: "Apple M2 Pro 32 GB macOS (MAC_M2PRO_32GB)"
            value: "MAC_M2PRO_32GB"
      - text: "Buildkite org API token (write scope)"
        key: bk_token
        required: true

  # 2. Terraform init & plan
  - label: ":terraform: init & plan"
    plugins:
      - docker#v3.8.0:
          image: hashicorp/terraform:1.5.7
          entrypoint: [""]               # clear Terraform’s ENTRYPOINT
          workdir: "terraform"           # run in repo-root/terraform
          command:
            - /bin/sh
            - -e
            - -c
            - |
              # Export the form inputs as Terraform vars
              export TF_VAR_org_slug="$(buildkite-agent meta-data get org_slug)"
              export TF_VAR_registry_name="$(buildkite-agent meta-data get registry)"
              export TF_VAR_queue_shape="$(buildkite-agent meta-data get shape)"
              export TF_VAR_buildkite_api_token="$(buildkite-agent meta-data get bk_token)"

              terraform init -input=false
              terraform plan -out=tf.plan
    artifact_paths:
      - "terraform/tf.plan"

  - wait

  # 3. Manual approval
  - block: ":white_check_mark: Apply the plan?"

  # 4. Terraform apply
  - label: ":rocket: terraform apply"
    plugins:
      - docker#v3.8.0:
          image: hashicorp/terraform:1.5.7
          entrypoint: [""]
          workdir: "terraform"
          command:
            - /bin/sh
            - -e
            - -c
            - |
              export TF_VAR_org_slug="$(buildkite-agent meta-data get org_slug)"
              export TF_VAR_registry_name="$(buildkite-agent meta-data get registry)"
              export TF_VAR_queue_shape="$(buildkite-agent meta-data get shape)"
              export TF_VAR_buildkite_api_token="$(buildkite-agent meta-data get bk_token)"

              terraform apply -auto-approve tf.plan