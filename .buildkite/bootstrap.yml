# .buildkite/bootstrap.yml

steps:
  # 1) Collect org slug, registry name, agent shape & API token from the user
  - block: ":gear: Configure Buildkite infra"
    prompt: "Enter your Buildkite org slug, registry name, agent shape and API token, then click Unblock"
    fields:
      - text:
          key: org_slug
          label: "Buildkite org slug"
          required: true
      - text:
          key: registry
          label: "Registry name"
          default: "bootstrap-example"
      - select:
          key: shape
          label: "Hosted agent shape"
          required: true
          options:
            - label: "2 vCPU / 4 GB Linux (LINUX_AMD64_2X4)"
              value: "LINUX_AMD64_2X4"
            - label: "4 vCPU / 8 GB Linux (LINUX_AMD64_4X8)"
              value: "LINUX_AMD64_4X8"
            - label: "Apple M2 Pro 32 GB macOS (MAC_M2PRO_32GB)"
              value: "MAC_M2PRO_32GB"
      - password:
          key: bk_token
          label: "Buildkite API token (write scope)"
          required: true

  # 2) Terraform plan in Docker
  - label: ":terraform: plan"
    agents:
      queue: "default"
    plugins:
      - docker#v3.7.0:
          image: hashicorp/terraform:1.5.7
          # override default ENTRYPOINT (which is `terraform`) so we can use shell
          entrypoint: ["/bin/sh", "-c"]
          always-pull: true              # always grab the latest image
          workdir: "terraform"           # cd into your ./terraform folder
          environment:                   # pass block fields as TF_VARs
            TF_VAR_org_slug:           "$ORG_SLUG"
            TF_VAR_registry_name:      "$REGISTRY"
            TF_VAR_queue_shape:        "$SHAPE"
            TF_VAR_buildkite_api_token: "$BK_TOKEN"
    command:
      - |
        terraform init -input=false
        terraform plan -out=tf.plan

  # 3) Pause for manual approval
  - wait
  - block: ":white_check_mark: Apply the plan?"

  # 4) Terraform apply in Docker
  - label: ":rocket: terraform apply"
    agents:
      queue: "default"
    plugins:
      - docker#v3.7.0:
          image: hashicorp/terraform:1.5.7
          entrypoint: ["/bin/sh", "-c"]
          always-pull: true
          workdir: "terraform"
          environment:
            TF_VAR_org_slug:           "$ORG_SLUG"
            TF_VAR_registry_name:      "$REGISTRY"
            TF_VAR_queue_shape:        "$SHAPE"
            TF_VAR_buildkite_api_token: "$BK_TOKEN"
    command:
      - terraform apply -auto-approve tf.plan
